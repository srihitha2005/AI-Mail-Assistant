<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <title>AI Email Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-gray-100">
    <div id="root"></div>

    <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function App() {
        // 1. Initialize emails state as an empty array
        const [emails, setEmails] = useState([]);
        const [selected, setSelected] = useState(null);
        const [currentView, setCurrentView] = useState('inbox');
        const [aiResponse, setAiResponse] = useState('');
        const chartRef = useRef(null);
        const chartInstance = useRef(null);

        // 2. Add useEffect to fetch data on component mount
        useEffect(() => {
        fetch('/static/emails.json')
            .then(response => {
            if (!response.ok) {
                // Handle HTTP errors
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
            })
            .then(data => {
            // 3. Update the state with fetched data
            setEmails(data);
            })
            .catch(error => {
            console.error("Could not fetch the email data:", error);
            });
        }, []); // Empty dependency array ensures this runs only once



        // Analytics calculations
        const analytics = {
          total: emails.length,
          answered: emails.filter(e => e.status === 'answered').length,
          pending: emails.filter(e => e.status === 'pending').length,
          positive: emails.filter(e => e.sentiment === 'Positive').length,
          negative: emails.filter(e => e.sentiment === 'Negative').length,
          neutral: emails.filter(e => e.sentiment === 'Neutral').length,
          urgent: emails.filter(e => e.priority === 'Urgent').length,
          notUrgent: emails.filter(e => e.priority === 'Not Urgent').length,
        };

        // Sorting: urgent first, unread first, then newest
        const sorted = [...emails].sort((a, b) => {
          if (a.priority === "Urgent" && b.priority !== "Urgent") return -1;
          if (b.priority === "Urgent" && a.priority !== "Urgent") return 1;
          if (!a.is_read && b.is_read) return -1;
          if (!b.is_read && a.is_read) return 1;
          return new Date(b.date_received) - new Date(a.date_received);
        });

        const markAnswered = (id) => {
          setEmails((prev) =>
            prev.map((e) =>
              e.id === id ? { ...e, status: "answered", is_read: true } : e
            )
          );
          setSelected(null);
          setAiResponse('');
        };

        const generateAiResponse = (email) => {
          // Use the llm_response field directly from the email object
          const llmResponse = email.llm_response;

          // Set the AI response from the field, or provide a fallback message
          setAiResponse(llmResponse || "Thank you for your message. Our team will review your request and respond shortly with a personalized solution.");
        };

        // Chart setup
        useEffect(() => {
          if (currentView === 'analytics' && chartRef.current) {
            if (chartInstance.current) {
              chartInstance.current.destroy();
            }

            const ctx = chartRef.current.getContext('2d');
            chartInstance.current = new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: ['Answered', 'Pending', 'Positive', 'Negative', 'Neutral', 'Urgent'],
                datasets: [{
                  data: [analytics.answered, analytics.pending, analytics.positive, analytics.negative, analytics.neutral, analytics.urgent],
                  backgroundColor: [
                    '#10B981', // green for answered
                    '#F59E0B', // yellow for pending  
                    '#06D6A0', // teal for positive
                    '#EF4444', // red for negative
                    '#6B7280', // gray for neutral
                    '#DC2626'  // dark red for urgent
                  ],
                  borderWidth: 2,
                  borderColor: '#1F2937'
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'bottom',
                    labels: { color: '#F3F4F6' }
                  }
                }
              }
            });
          }

          return () => {
            if (chartInstance.current) {
              chartInstance.current.destroy();
            }
          };
        }, [currentView, analytics]);

        return (
          <div className="flex h-screen text-gray-200">
            {/* Enhanced Sidebar */}
            <aside className="w-20 bg-gradient-to-b from-gray-800 to-gray-900 flex flex-col items-center py-6 space-y-8 shadow-2xl">
              <div className="text-2xl font-bold text-blue-400 mb-4">AI</div>
              
              <button 
                onClick={() => setCurrentView('inbox')}
                className={`p-3 rounded-xl transition-all duration-300 hover:scale-110 ${
                  currentView === 'inbox' ? 'bg-blue-600 shadow-lg' : 'hover:bg-gray-700'
                }`}
                title="Inbox"
              >
                <span className="text-2xl">üì•</span>
              </button>
              
              <button 
                onClick={() => setCurrentView('analytics')}
                className={`p-3 rounded-xl transition-all duration-300 hover:scale-110 ${
                  currentView === 'analytics' ? 'bg-purple-600 shadow-lg' : 'hover:bg-gray-700'
                }`}
                title="Analytics"
              >
                <span className="text-2xl">üìä</span>
              </button>

              <div className="flex-1"></div>
              <div className="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500"></div>
            </aside>

            {/* Main Content */}
            <main className="flex-1 flex flex-col">
              {/* Enhanced Header */}
              <div className="p-6 bg-gradient-to-r from-gray-800 to-gray-700 shadow-lg">
                <div className="flex justify-between items-center mb-4">
                  <h1 className="text-2xl font-bold text-white">
                    {currentView === 'inbox' ? '‚úâÔ∏è Email Dashboard' : 'üìà Analytics Dashboard'}
                  </h1>
                  <div className="text-sm text-gray-300">
                    {new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                  </div>
                </div>
                
                <div className="grid grid-cols-6 gap-4 text-center">
                  <div className="bg-gray-700 p-3 rounded-lg">
                    <div className="text-2xl font-bold text-blue-400">{analytics.total}</div>
                    <div className="text-xs text-gray-300">Total</div>
                  </div>
                  <div className="bg-gray-700 p-3 rounded-lg">
                    <div className="text-2xl font-bold text-green-400">{analytics.answered}</div>
                    <div className="text-xs text-gray-300">Resolved</div>
                  </div>
                  <div className="bg-gray-700 p-3 rounded-lg">
                    <div className="text-2xl font-bold text-yellow-400">{analytics.pending}</div>
                    <div className="text-xs text-gray-300">Pending</div>
                  </div>
                  <div className="bg-gray-700 p-3 rounded-lg">
                    <div className="text-2xl font-bold text-red-400">{analytics.urgent}</div>
                    <div className="text-xs text-gray-300">Urgent</div>
                  </div>
                  <div className="bg-gray-700 p-3 rounded-lg">
                    <div className="text-2xl font-bold text-green-400">{analytics.positive}</div>
                    <div className="text-xs text-gray-300">Positive</div>
                  </div>
                  <div className="bg-gray-700 p-3 rounded-lg">
                    <div className="text-2xl font-bold text-red-400">{analytics.negative}</div>
                    <div className="text-xs text-gray-300">Negative</div>
                  </div>
                </div>
              </div>

              {/* Content Area */}
              {currentView === 'inbox' ? (
                <div className="flex flex-1 overflow-hidden">
                  {/* Email List */}
                  <div className="w-1/3 overflow-y-auto p-4 space-y-4 bg-gray-900">
                    {sorted.map((email) => (
                      <div
                        key={email.id}
                        onClick={() => setSelected(email)}
                        className={`p-4 rounded-xl cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-xl ${
                          email.is_read 
                            ? "bg-gradient-to-r from-gray-700 to-gray-600" 
                            : "bg-gradient-to-r from-blue-800 to-blue-700 shadow-lg"
                        } ${selected?.id === email.id ? 'ring-2 ring-blue-400' : ''}`}
                      >
                        <div className="flex items-center justify-between mb-2">
                          <div className="font-semibold text-white truncate flex-1">
                            {email.sender_email}
                          </div>
                          {!email.is_read && <div className="w-3 h-3 bg-blue-400 rounded-full"></div>}
                        </div>
                        <div className="text-sm text-gray-300 mb-3 line-clamp-2">{email.subject}</div>
                        <div className="flex gap-2 flex-wrap">
                          <span
                            className={`px-2 py-1 rounded-full text-xs font-medium ${
                              email.sentiment === "Negative"
                                ? "bg-red-500 text-white"
                                : email.sentiment === "Positive"
                                ? "bg-green-500 text-white"
                                : "bg-gray-500 text-white"
                            }`}
                          >
                            {email.sentiment}
                          </span>
                          <span
                            className={`px-2 py-1 rounded-full text-xs font-medium ${
                              email.priority === "Urgent"
                                ? "bg-red-600 text-white animate-pulse"
                                : "bg-gray-600 text-white"
                            }`}
                          >
                            {email.priority}
                          </span>
                          {/* <span className="px-2 py-1 bg-blue-600 rounded-full text-xs font-medium text-white">
                             {email.ai_label.split('-')[0]}
                           </span> */}
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* Email Detail */}
                  {selected && (
                    <div className="flex-1 bg-gradient-to-br from-gray-800 to-gray-700 p-8 overflow-y-auto">
                      <div className="max-w-4xl">
                        <div className="bg-gray-900 p-6 rounded-xl shadow-2xl mb-6">
                          <h2 className="text-2xl font-bold text-white mb-4">{selected.subject}</h2>
                          <div className="flex items-center justify-between text-sm text-gray-400 mb-6">
                            <span>From: <span className="text-blue-400 font-medium">{selected.sender_email}</span></span>
                            <span>{new Date(selected.date_received).toLocaleString()}</span>
                          </div>
                          <div className="text-gray-200 leading-relaxed bg-gray-800 p-4 rounded-lg">
                            {selected.body}
                          </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6 mb-6">
                          <div className="bg-gray-900 p-6 rounded-xl shadow-xl">
                            <h3 className="text-lg font-semibold text-white mb-4 flex items-center">
                              <span className="text-xl mr-2">ü§ñ</span> AI Analysis
                            </h3>
                            <div className="space-y-2 text-sm">
                             {/*} <p><span className="text-gray-400">Label:</span> <span className="text-blue-400">{}</span></p> */}
                              <p><span className="text-gray-400">Request:</span> <span className="text-gray-200">{selected.ai_label}</span></p>
                              <p><span className="text-gray-400">Contact:</span> <span className="text-gray-200">{selected.extracted_info.contact_details}</span></p>
                            </div>
                          </div>

                          <div className="bg-gray-900 p-6 rounded-xl shadow-xl">
                            <h3 className="text-lg font-semibold text-white mb-4 flex items-center">
                              <span className="text-xl mr-2">üìä</span> Email Metrics
                            </h3>
                            <div className="space-y-2 text-sm">
                              <div className="flex justify-between">
                                <span className="text-gray-400">Priority:</span>
                                <span className={`font-medium ${selected.priority === 'Urgent' ? 'text-red-400' : 'text-gray-200'}`}>
                                  {selected.priority}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-400">Sentiment:</span>
                                <span className={`font-medium ${
                                  selected.sentiment === 'Positive' ? 'text-green-400' : 
                                  selected.sentiment === 'Negative' ? 'text-red-400' : 'text-gray-200'
                                }`}>
                                  {selected.sentiment}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-gray-400">Status:</span>
                                <span className={`font-medium ${selected.status === 'answered' ? 'text-green-400' : 'text-yellow-400'}`}>
                                  {selected.status.charAt(0).toUpperCase() + selected.status.slice(1)}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div className="bg-gray-900 p-6 rounded-xl shadow-2xl">
                          <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-white flex items-center">
                              <span className="text-xl mr-2">üí¨</span> AI Response
                            </h3>
                            <button
                              onClick={() => generateAiResponse(selected)}
                              className="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition-colors duration-300 text-sm font-medium"
                            >
                              Generate Response
                            </button>
                          </div>
                          <textarea
                            value={aiResponse}
                            onChange={(e) => setAiResponse(e.target.value)}
                            className="w-full mt-2 p-4 rounded-lg bg-gray-800 text-gray-200 border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors duration-300"
                            rows="6"
                            placeholder="AI-generated response will appear here..."
                          />
                          <div className="flex gap-3 mt-4">
                            <button 
                              onClick={() => generateAiResponse(selected)}
                              className="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg transition-all duration-300 hover:shadow-lg font-medium"
                            >
                              ‚úèÔ∏è Review/Edit
                            </button>
                            <button
                              onClick={() => markAnswered(selected.id)}
                              className="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg transition-all duration-300 hover:shadow-lg font-medium"
                            >
                              ‚úÖ Mark Answered
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              ) : (
                // Analytics View
                <div className="flex-1 p-8 bg-gradient-to-br from-gray-900 to-gray-800 overflow-y-auto">
                  <div className="max-w-6xl mx-auto">
                    <div className="grid lg:grid-cols-3 gap-8 mb-8">
                      {/* Chart */}
                      <div className="lg:col-span-2 bg-gray-800 p-6 rounded-xl shadow-2xl">
                        <h3 className="text-xl font-bold text-white mb-6 flex items-center">
                          <span className="text-2xl mr-2">üìä</span> Email Distribution
                        </h3>
                        <canvas ref={chartRef} className="max-h-80"></canvas>
                      </div>

                      {/* Stats Cards */}
                      <div className="space-y-6">
                        <div className="bg-gradient-to-r from-green-700 to-green-600 p-6 rounded-xl shadow-xl">
                          <div className="text-3xl font-bold text-white">{analytics.answered}</div>
                          <div className="text-green-100">Emails Resolved</div>
                          <div className="text-sm text-green-200 mt-1">
                            {((analytics.answered / analytics.total) * 100).toFixed(1)}% completion rate
                          </div>
                        </div>

                        <div className="bg-gradient-to-r from-red-700 to-red-600 p-6 rounded-xl shadow-xl">
                          <div className="text-3xl font-bold text-white">{analytics.urgent}</div>
                          <div className="text-red-100">Urgent Emails</div>
                          <div className="text-sm text-red-200 mt-1">
                            Require immediate attention
                          </div>
                        </div>

                        <div className="bg-gradient-to-r from-blue-700 to-blue-600 p-6 rounded-xl shadow-xl">
                          <div className="text-3xl font-bold text-white">
                            {((analytics.positive / analytics.total) * 100).toFixed(0)}%
                          </div>
                          <div className="text-blue-100">Positive Sentiment</div>
                          <div className="text-sm text-blue-200 mt-1">
                            Customer satisfaction indicator
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Detailed Analytics Grid */}
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                      <div className="bg-gray-800 p-6 rounded-xl shadow-xl">
                        <h4 className="text-lg font-semibold text-white mb-4">üìà Status Breakdown</h4>
                        <div className="space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-gray-300">Answered</span>
                            <div className="flex items-center">
                              <div className="w-24 bg-gray-700 rounded-full h-2 mr-3">
                                <div className="bg-green-500 h-2 rounded-full" style={{width: `${(analytics.answered/analytics.total)*100}%`}}></div>
                              </div>
                              <span className="text-green-400 font-medium">{analytics.answered}</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-gray-300">Pending</span>
                            <div className="flex items-center">
                              <div className="w-24 bg-gray-700 rounded-full h-2 mr-3">
                                <div className="bg-yellow-500 h-2 rounded-full" style={{width: `${(analytics.pending/analytics.total)*100}%`}}></div>
                              </div>
                              <span className="text-yellow-400 font-medium">{analytics.pending}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className="bg-gray-800 p-6 rounded-xl shadow-xl">
                        <h4 className="text-lg font-semibold text-white mb-4">üòä Sentiment Analysis</h4>
                        <div className="space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-gray-300">Positive</span>
                            <div className="flex items-center">
                              <div className="w-24 bg-gray-700 rounded-full h-2 mr-3">
                                <div className="bg-green-500 h-2 rounded-full" style={{width: `${(analytics.positive/analytics.total)*100}%`}}></div>
                              </div>
                              <span className="text-green-400 font-medium">{analytics.positive}</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-gray-300">Negative</span>
                            <div className="flex items-center">
                              <div className="w-24 bg-gray-700 rounded-full h-2 mr-3">
                                <div className="bg-red-500 h-2 rounded-full" style={{width: `${(analytics.negative/analytics.total)*100}%`}}></div>
                              </div>
                              <span className="text-red-400 font-medium">{analytics.negative}</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-gray-300">Neutral</span>
                            <div className="flex items-center">
                              <div className="w-24 bg-gray-700 rounded-full h-2 mr-3">
                                <div className="bg-gray-500 h-2 rounded-full" style={{width: `${(analytics.neutral/analytics.total)*100}%`}}></div>
                              </div>
                              <span className="text-gray-400 font-medium">{analytics.neutral}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className="bg-gray-800 p-6 rounded-xl shadow-xl">
                        <h4 className="text-lg font-semibold text-white mb-4">‚ö° Priority Levels</h4>
                        <div className="space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-gray-300">Urgent</span>
                            <div className="flex items-center">
                              <div className="w-24 bg-gray-700 rounded-full h-2 mr-3">
                                <div className="bg-red-500 h-2 rounded-full" style={{width: `${(analytics.urgent/analytics.total)*100}%`}}></div>
                              </div>
                              <span className="text-red-400 font-medium">{analytics.urgent}</span>
                            </div>
                          </div>
                          <div className="flex justify-between items-center">
                            <span className="text-gray-300">Normal</span>
                            <div className="flex items-center">
                              <div className="w-24 bg-gray-700 rounded-full h-2 mr-3">
                                <div className="bg-blue-500 h-2 rounded-full" style={{width: `${(analytics.notUrgent/analytics.total)*100}%`}}></div>
                              </div>
                              <span className="text-blue-400 font-medium">{analytics.notUrgent}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </main>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
